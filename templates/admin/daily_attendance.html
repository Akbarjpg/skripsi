<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Daily Attendance - Admin</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
      }

      .header {
        background-color: #2c3e50;
        color: white;
        padding: 1rem 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .nav {
        background-color: #34495e;
        padding: 0.5rem 2rem;
      }

      .nav a {
        color: white;
        text-decoration: none;
        margin-right: 2rem;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        transition: background-color 0.3s;
      }

      .nav a:hover {
        background-color: #2c3e50;
      }
      .nav a.active {
        background-color: #2c3e50;
      }

      .container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 2rem;
      }

      .date-selector {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .card h3 {
        color: #2c3e50;
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }

      .card .value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #3498db;
        margin-bottom: 0.5rem;
      }

      .card.success .value {
        color: #27ae60;
      }
      .card.warning .value {
        color: #f39c12;
      }
      .card.danger .value {
        color: #e74c3c;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      th,
      td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #ecf0f1;
      }

      th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
      }

      .status-success {
        color: #27ae60;
        font-weight: bold;
      }

      .status-failed {
        color: #e74c3c;
        font-weight: bold;
      }

      .btn {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin: 0.25rem;
      }

      .btn:hover {
        background-color: #2980b9;
      }

      .empty-state {
        text-align: center;
        padding: 3rem;
        color: #7f8c8d;
      }

      input[type="date"] {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-right: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Daily Attendance Report</h1>
      <p>View and analyze daily attendance records</p>
    </div>

    <div class="nav">
      <a href="/admin">Dashboard</a>
      <a href="/admin/attendance/daily" class="active">Daily Attendance</a>
      <a href="/admin/attendance/weekly">Weekly Reports</a>
      <a href="/admin/users">Users</a>
      <a href="/admin/reports">Reports</a>
      <a href="/admin/system_status">System Status</a>
    </div>

    <div class="container">
      <!-- Date Selector -->
      <div class="date-selector">
        <h3>Select Date</h3>
        <form method="GET" style="margin-top: 1rem">
          <input
            type="date"
            name="date"
            value="{{ selected_date }}"
            onchange="this.form.submit()"
          />
          <button type="submit" class="btn">View Date</button>
          <a href="/admin/attendance/daily" class="btn">Today</a>
        </form>
      </div>

      <!-- Summary Cards -->
      <h2>Summary for {{ report.summary.date }}</h2>
      <div class="summary-grid">
        <div class="card">
          <h3>Total Attempts</h3>
          <div class="value">{{ report.summary.total_attempts or 0 }}</div>
        </div>

        <div class="card success">
          <h3>Successful</h3>
          <div class="value">
            {{ report.summary.successful_attendance or 0 }}
          </div>
        </div>

        <div class="card warning">
          <h3>Failed Anti-spoofing</h3>
          <div class="value">{{ report.summary.failed_antispoofing or 0 }}</div>
        </div>

        <div class="card">
          <h3>Unique Users</h3>
          <div class="value">{{ report.summary.unique_users or 0 }}</div>
        </div>

        <div
          class="card {% if report.summary.success_rate >= 90 %}success{% elif report.summary.success_rate >= 70 %}warning{% else %}danger{% endif %}"
        >
          <h3>Success Rate</h3>
          <div class="value">
            {{ "%.1f"|format(report.summary.success_rate or 0) }}%
          </div>
        </div>
      </div>

      <!-- Export Options -->
      <div style="margin: 1rem 0">
        <button onclick="exportDailyData('{{ selected_date }}')" class="btn">
          Export CSV
        </button>
        <button onclick="generateHTMLReport('{{ selected_date }}')" class="btn">
          Generate HTML Report
        </button>
      </div>

      <!-- Attendance Records -->
      <h2>Attendance Records</h2>
      {% if report.attendance_records %}
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>User ID</th>
            <th>Name</th>
            <th>Status</th>
            <th>Confidence</th>
            <th>Anti-spoofing</th>
            <th>Processing Time</th>
          </tr>
        </thead>
        <tbody>
          {% for record in report.attendance_records %}
          <tr>
            <td>
              {{ record.timestamp.split(' ')[1] if ' ' in record.timestamp else
              record.timestamp }}
            </td>
            <td>{{ record.user_id }}</td>
            <td>{{ record.user_name or 'Unknown' }}</td>
            <td class="status-{{ record.status }}">
              {{ record.status.title() }}
            </td>
            <td>
              {{ "%.3f"|format(record.confidence_score) if
              record.confidence_score else 'N/A' }}
            </td>
            <td>
              {% if record.antispoofing_passed %}
              <span style="color: green">✓ Passed</span>
              {% elif record.antispoofing_passed == False %}
              <span style="color: red">✗ Failed</span>
              {% else %} N/A {% endif %}
            </td>
            <td>
              {{ "%.3f"|format(record.recognition_time) if
              record.recognition_time else 'N/A' }}s
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="empty-state">
        <h3>No attendance records for this date</h3>
        <p>
          No one attempted to use the attendance system on {{ selected_date }}
        </p>
      </div>
      {% endif %}

      <!-- Navigation -->
      <div style="text-align: center; margin-top: 2rem">
        {% set prev_date = (selected_date | datetime_parse -
        timedelta(days=1)).strftime('%Y-%m-%d') %} {% set next_date =
        (selected_date | datetime_parse +
        timedelta(days=1)).strftime('%Y-%m-%d') %}

        <a href="/admin/attendance/daily?date={{ prev_date }}" class="btn"
          >← Previous Day</a
        >
        <a href="/admin/attendance/daily" class="btn">Today</a>
        {% if next_date <= today() %}
        <a href="/admin/attendance/daily?date={{ next_date }}" class="btn"
          >Next Day →</a
        >
        {% endif %}
      </div>
    </div>

    <script>
      function exportDailyData(date) {
        fetch("/admin/api/export_data", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            export_type: "csv",
            days: 1,
            specific_date: date,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Data exported successfully!");
              // Could add download link here
            } else {
              alert("Export failed: " + data.error);
            }
          })
          .catch((error) => {
            alert("Export failed: " + error);
          });
      }

      function generateHTMLReport(date) {
        fetch("/admin/api/generate_report", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            report_type: "daily",
            date: date,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            // Create and download HTML report
            const blob = new Blob([generateHTMLContent(data)], {
              type: "text/html",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `daily_report_${date}.html`;
            a.click();
            URL.revokeObjectURL(url);
          })
          .catch((error) => {
            alert("Report generation failed: " + error);
          });
      }

      function generateHTMLContent(reportData) {
        return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Daily Attendance Report - ${
                      reportData.summary.date
                    }</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #2c3e50; }
                        .summary { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h1>Daily Attendance Report</h1>
                    <p>Date: ${reportData.summary.date}</p>
                    <p>Generated: ${new Date().toISOString()}</p>
                    
                    <div class="summary">
                        <h2>Summary</h2>
                        <p>Total Attempts: ${
                          reportData.summary.total_attempts || 0
                        }</p>
                        <p>Successful: ${
                          reportData.summary.successful_attendance || 0
                        }</p>
                        <p>Success Rate: ${(
                          reportData.summary.success_rate || 0
                        ).toFixed(1)}%</p>
                        <p>Unique Users: ${
                          reportData.summary.unique_users || 0
                        }</p>
                    </div>
                    
                    <h2>Detailed Records</h2>
                    <table>
                        <tr>
                            <th>Time</th>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Confidence</th>
                        </tr>
                        ${reportData.attendance_records
                          .map(
                            (record) => `
                            <tr>
                                <td>${record.timestamp}</td>
                                <td>${record.user_id}</td>
                                <td>${record.user_name || "Unknown"}</td>
                                <td>${record.status}</td>
                                <td>${
                                  record.confidence_score
                                    ? record.confidence_score.toFixed(3)
                                    : "N/A"
                                }</td>
                            </tr>
                        `
                          )
                          .join("")}
                    </table>
                </body>
                </html>
            `;
      }
    </script>
  </body>
</html>
