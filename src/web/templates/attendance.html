<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance Verification - SecureAttend</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .main-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .verification-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .video-container {
        position: relative;
        background: #000;
        border-radius: 15px;
        overflow: hidden;
      }

      #videoElement {
        width: 100%;
        height: 400px;
        object-fit: cover;
      }

      #landmarkCanvas {
        width: 100%;
        height: 400px;
      }

      .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
      }

      .challenge-display {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 25px;
        border-radius: 25px;
        font-weight: bold;
        text-align: center;
        min-width: 300px;
      }

      .score-card {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
      }

      .method-status {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        margin: 10px 0;
        border-radius: 10px;
        background: #f8f9fa;
      }

      .method-status.passed {
        background: #d4edda;
        border-left: 5px solid #28a745;
      }

      .method-status.failed {
        background: #f8d7da;
        border-left: 5px solid #dc3545;
      }

      .method-status.pending {
        background: #fff3cd;
        border-left: 5px solid #ffc107;
      }

      .progress-ring {
        width: 120px;
        height: 120px;
        margin: 0 auto;
      }

      .progress-ring-circle {
        stroke: #e9ecef;
        stroke-width: 8;
        fill: transparent;
        transform-origin: 50% 50%;
        transform: rotate(-90deg);
      }

      .progress-ring-circle.active {
        stroke: #28a745;
        stroke-dasharray: 377;
        stroke-dashoffset: 377;
        transition: stroke-dashoffset 0.5s;
      }

      .btn-verify {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        color: white;
        padding: 15px 30px;
        border-radius: 25px;
        font-weight: bold;
        font-size: 1.1rem;
        transition: all 0.3s ease;
      }

      .btn-verify:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        color: white;
      }

      .btn-verify:disabled {
        background: #6c757d;
        transform: none;
        box-shadow: none;
      }

      .status-indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 10px;
      }

      .status-indicator.success {
        background: #28a745;
      }

      .status-indicator.error {
        background: #dc3545;
      }

      .status-indicator.warning {
        background: #ffc107;
      }

      .status-indicator.pending {
        background: #6c757d;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .verification-steps {
        margin-top: 20px;
      }

      .step {
        display: flex;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }

      .step:last-child {
        border-bottom: none;
      }

      .step-number {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #6c757d;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-weight: bold;
      }

      .step-number.active {
        background: #007bff;
      }

      .step-number.completed {
        background: #28a745;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <!-- Header -->
      <div class="text-center text-white mb-4">
        <h1 class="display-4 fw-bold">
          <i class="fas fa-shield-alt me-3"></i>
          Verifikasi Kehadiran
        </h1>
        <p class="lead">Sistem Anti-Spoofing dengan Teknologi AI</p>

        <!-- Mode Selection -->
        <div class="row justify-content-center mt-4">
          <div class="col-md-8">
            <div class="card bg-dark bg-opacity-50 border-light">
              <div class="card-body p-3">
                <h5 class="text-white mb-3">
                  <i class="fas fa-cog me-2"></i>
                  Pilih Mode Deteksi
                </h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <a
                      href="/attendance-sequential"
                      class="btn btn-success btn-lg w-100"
                    >
                      <i class="fas fa-list-ol me-2"></i>
                      <strong>Sequential Mode</strong><br />
                      <small
                        >Tahap 1: Anti-Spoofing â†’ Tahap 2: Face
                        Recognition</small
                      >
                    </a>
                  </div>
                  <div class="col-md-6">
                    <button
                      class="btn btn-primary btn-lg w-100"
                      onclick="startParallelMode()"
                    >
                      <i class="fas fa-layer-group me-2"></i>
                      <strong>Parallel Mode</strong><br />
                      <small
                        >Semua metode berjalan bersamaan (Current Page)</small
                      >
                    </button>
                  </div>
                </div>
                <div class="text-center mt-3">
                  <small class="text-light">
                    <i class="fas fa-info-circle me-1"></i>
                    Sequential mode memberikan pengalaman yang lebih terarah dan
                    mudah diikuti
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="verification-card">
        <div class="row g-0">
          <!-- Video Section -->
          <div class="col-lg-8">
            <div class="p-4">
              <div class="video-container">
                <video id="videoElement" autoplay muted playsinline></video>

                <!-- Landmark Overlay Canvas -->
                <canvas
                  id="landmarkCanvas"
                  style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    pointer-events: none;
                    z-index: 2;
                  "
                ></canvas>

                <!-- Challenge Display -->
                <div
                  id="challengeDisplay"
                  class="challenge-display"
                  style="display: none"
                >
                  <div id="challengeText">Memuat tantangan...</div>
                  <div class="mt-2">
                    <small
                      >Sisa waktu:
                      <span id="challengeTimer">0</span> detik</small
                    >
                  </div>
                </div>

                <!-- Video Overlay -->
                <div id="videoOverlay" class="video-overlay">
                  <div class="text-center">
                    <i class="fas fa-video fa-3x mb-3"></i>
                    <p>Mengaktifkan kamera...</p>
                    <button id="startCameraBtn" class="btn btn-primary">
                      <i class="fas fa-play me-2"></i>Aktifkan Kamera
                    </button>
                  </div>
                </div>
              </div>

              <!-- Controls -->
              <div class="text-center mt-3">
                <button
                  id="startVerificationBtn"
                  class="btn btn-verify me-3"
                  disabled
                >
                  <i class="fas fa-user-check me-2"></i>
                  Mulai Verifikasi
                </button>
                <button
                  id="stopVerificationBtn"
                  class="btn btn-outline-danger"
                  style="display: none"
                >
                  <i class="fas fa-stop me-2"></i>
                  Berhenti
                </button>
              </div>
            </div>
          </div>

          <!-- Status Panel -->
          <div class="col-lg-4">
            <div class="p-4 border-start">
              <h5 class="fw-bold mb-4">
                <i class="fas fa-clipboard-check me-2"></i>
                Status Verifikasi
              </h5>

              <!-- Overall Score -->
              <div class="score-card">
                <div class="progress-ring">
                  <svg width="120" height="120">
                    <circle
                      class="progress-ring-circle"
                      cx="60"
                      cy="60"
                      r="60"
                    ></circle>
                    <circle
                      id="progressCircle"
                      class="progress-ring-circle active"
                      cx="60"
                      cy="60"
                      r="60"
                    ></circle>
                  </svg>
                </div>
                <h3 id="overallScore" class="mt-3 mb-1">0%</h3>
                <p class="mb-0">Skor Keamanan</p>
              </div>

              <!-- Verification Methods -->
              <div class="verification-methods">
                <h6 class="fw-bold mb-3">Metode Verifikasi:</h6>

                <!-- CNN Detection -->
                <div id="cnnStatus" class="method-status pending">
                  <div>
                    <span class="status-indicator pending"></span>
                    <strong>CNN Liveness</strong>
                    <br />
                    <small class="text-muted">Deep Learning Detection</small>
                  </div>
                  <div class="text-end">
                    <span id="cnnScore" class="fw-bold">0%</span>
                  </div>
                </div>

                <!-- Landmark Detection -->
                <div id="landmarkStatus" class="method-status pending">
                  <div>
                    <span class="status-indicator pending"></span>
                    <strong>Facial Landmarks</strong>
                    <br />
                    <small class="text-muted">Gerakan Alami</small>
                  </div>
                  <div class="text-end">
                    <span id="landmarkScore" class="fw-bold">0%</span>
                  </div>
                </div>

                <!-- Challenge Response -->
                <div id="challengeStatus" class="method-status pending">
                  <div>
                    <span class="status-indicator pending"></span>
                    <strong>Challenge Response</strong>
                    <br />
                    <small class="text-muted">Interaksi Real-time</small>
                  </div>
                  <div class="text-end">
                    <span id="challengeScore" class="fw-bold">0%</span>
                  </div>
                </div>
              </div>

              <!-- Verification Steps -->
              <div class="verification-steps">
                <h6 class="fw-bold mb-3">Langkah Verifikasi:</h6>

                <div class="step">
                  <div id="step1" class="step-number">1</div>
                  <div>
                    <strong>Deteksi Wajah</strong>
                    <br />
                    <small class="text-muted"
                      >Pastikan wajah terlihat jelas</small
                    >
                  </div>
                </div>

                <div class="step">
                  <div id="step2" class="step-number">2</div>
                  <div>
                    <strong>Analisis Liveness</strong>
                    <br />
                    <small class="text-muted"
                      >AI menganalisis keaslian wajah</small
                    >
                  </div>
                </div>

                <div class="step">
                  <div id="step3" class="step-number">3</div>
                  <div>
                    <strong>Challenge Response</strong>
                    <br />
                    <small class="text-muted"
                      >Ikuti instruksi yang muncul</small
                    >
                  </div>
                </div>

                <div class="step">
                  <div id="step4" class="step-number">4</div>
                  <div>
                    <strong>Verifikasi Selesai</strong>
                    <br />
                    <small class="text-muted">Kehadiran berhasil dicatat</small>
                  </div>
                </div>
              </div>

              <!-- Final Result -->
              <div id="finalResult" class="mt-4" style="display: none">
                <div class="alert alert-success text-center">
                  <i class="fas fa-check-circle fa-2x mb-2"></i>
                  <h5>Verifikasi Berhasil!</h5>
                  <p class="mb-0">Kehadiran Anda telah tercatat.</p>
                </div>
                <button id="recordAttendanceBtn" class="btn btn-success w-100">
                  <i class="fas fa-save me-2"></i>
                  Catat Kehadiran
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Back Button -->
      <div class="text-center mt-4">
        <a href="/" class="btn btn-outline-light">
          <i class="fas fa-arrow-left me-2"></i>
          Kembali ke Beranda
        </a>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

    <script>
      class AttendanceVerifier {
        constructor() {
          this.socket = io();
          this.videoElement = document.getElementById("videoElement");
          this.landmarkCanvas = document.getElementById("landmarkCanvas");
          this.landmarkCtx = this.landmarkCanvas.getContext("2d");
          this.stream = null;
          this.isVerifying = false;
          this.sessionId = null;
          this.verificationData = {};

          this.setupEventListeners();
          this.setupSocketListeners();
        }

        setupEventListeners() {
          document
            .getElementById("startCameraBtn")
            .addEventListener("click", () => {
              this.startCamera();
            });

          document
            .getElementById("startVerificationBtn")
            .addEventListener("click", () => {
              this.startVerification();
            });

          document
            .getElementById("stopVerificationBtn")
            .addEventListener("click", () => {
              this.stopVerification();
            });

          document
            .getElementById("recordAttendanceBtn")
            .addEventListener("click", () => {
              this.recordAttendance();
            });
        }

        setupSocketListeners() {
          this.socket.on("verification_results", (data) => {
            this.updateVerificationStatus(data);
            this.drawLandmarks(data);
          });

          this.socket.on("error", (data) => {
            console.error("Socket error:", data);
            this.showError(data.message);
          });
        }

        async startCamera() {
          try {
            this.stream = await navigator.mediaDevices.getUserMedia({
              video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: "user",
              },
              audio: false,
            });

            this.videoElement.srcObject = this.stream;
            document.getElementById("videoOverlay").style.display = "none";
            document.getElementById("startVerificationBtn").disabled = false;
          } catch (error) {
            console.error("Error accessing camera:", error);
            this.showError(
              "Tidak dapat mengakses kamera. Pastikan izin kamera telah diberikan."
            );
          }
        }

        drawLandmarks(data) {
          // Resize canvas to match video
          const videoRect = this.videoElement.getBoundingClientRect();
          this.landmarkCanvas.width = this.videoElement.videoWidth || 640;
          this.landmarkCanvas.height = this.videoElement.videoHeight || 480;

          // Set canvas display size to match video
          this.landmarkCanvas.style.width = videoRect.width + "px";
          this.landmarkCanvas.style.height = videoRect.height + "px";

          // Clear previous drawings
          this.landmarkCtx.clearRect(
            0,
            0,
            this.landmarkCanvas.width,
            this.landmarkCanvas.height
          );

          // Draw landmark points if available
          if (data.landmark_points && data.landmark_points.length > 0) {
            data.landmark_points.forEach((point) => {
              // Scale coordinates to canvas size
              const x = (point.x / 640) * this.landmarkCanvas.width;
              const y = (point.y / 480) * this.landmarkCanvas.height;

              this.landmarkCtx.beginPath();
              this.landmarkCtx.arc(x, y, 2, 0, 2 * Math.PI);
              this.landmarkCtx.fillStyle = point.color;
              this.landmarkCtx.fill();
              this.landmarkCtx.strokeStyle = "#ffffff";
              this.landmarkCtx.lineWidth = 0.5;
              this.landmarkCtx.stroke();
            });

            // Add text overlay showing detection status
            this.landmarkCtx.fillStyle = "rgba(0, 0, 0, 0.7)";
            this.landmarkCtx.fillRect(10, 10, 300, 80);

            this.landmarkCtx.fillStyle = "#ffffff";
            this.landmarkCtx.font = "14px Arial";
            this.landmarkCtx.fillText(
              `Landmarks: ${
                data.landmark_count || data.landmark_points.length
              } points`,
              20,
              30
            );
            this.landmarkCtx.fillText(
              `Liveness: ${(data.liveness_score * 100).toFixed(1)}%`,
              20,
              50
            );
            this.landmarkCtx.fillText(
              `CNN Score: ${(data.cnn_score * 100).toFixed(1)}%`,
              20,
              70
            );

            // Security status indicator
            const securityColor =
              data.security_level === "SECURE" ? "#00ff00" : "#ffaa00";
            this.landmarkCtx.fillStyle = securityColor;
            this.landmarkCtx.fillText(
              `Security: ${data.security_level}`,
              180,
              30
            );
          }
        }

        async startVerification() {
          try {
            // Start verification session
            const response = await fetch("/api/start_verification", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            });

            const data = await response.json();
            this.sessionId = data.session_id;

            // Show challenge
            this.showChallenge(data.challenge);

            // Start processing frames
            this.isVerifying = true;
            this.processFrames();

            // Update UI
            document.getElementById("startVerificationBtn").style.display =
              "none";
            document.getElementById("stopVerificationBtn").style.display =
              "inline-block";
            document.getElementById("step1").classList.add("active");
          } catch (error) {
            console.error("Error starting verification:", error);
            this.showError("Gagal memulai verifikasi. Silakan coba lagi.");
          }
        }

        stopVerification() {
          this.isVerifying = false;
          document.getElementById("startVerificationBtn").style.display =
            "inline-block";
          document.getElementById("stopVerificationBtn").style.display = "none";
          document.getElementById("challengeDisplay").style.display = "none";
          this.resetSteps();
        }

        processFrames() {
          if (!this.isVerifying) return;

          // Capture frame
          const canvas = document.createElement("canvas");
          canvas.width = this.videoElement.videoWidth;
          canvas.height = this.videoElement.videoHeight;

          const ctx = canvas.getContext("2d");
          ctx.drawImage(this.videoElement, 0, 0);

          const imageData = canvas.toDataURL("image/jpeg", 0.8);

          // Send to server for processing
          this.socket.emit("process_frame", {
            image: imageData,
            session_id: this.sessionId,
          });

          // Continue processing
          setTimeout(() => this.processFrames(), 200); // Process at 5 FPS
        }

        updateVerificationStatus(data) {
          // Update CNN score
          this.updateMethodStatus("cnn", data.cnn_score, 0.7);

          // Update Landmark score
          this.updateMethodStatus("landmark", data.landmark_score, 0.7);

          // Update Challenge score
          this.updateMethodStatus("challenge", data.challenge_score, 0.7);

          // Update overall score
          const overallScore = data.fusion_score * 100;
          this.updateOverallScore(overallScore);

          // Update challenge display
          if (data.challenge_status) {
            this.updateChallengeDisplay(data.challenge_status);
          }

          // Update steps
          this.updateSteps(data);

          // Check for completion
          if (data.challenge_completed) {
            this.verificationData = data;
            this.completeVerification(data.verification_success);
          }
        }

        updateMethodStatus(method, score, threshold) {
          const scorePercent = Math.round(score * 100);
          const element = document.getElementById(`${method}Status`);
          const scoreElement = document.getElementById(`${method}Score`);
          const indicator = element.querySelector(".status-indicator");

          scoreElement.textContent = `${scorePercent}%`;

          if (score >= threshold) {
            element.className = "method-status passed";
            indicator.className = "status-indicator success";
          } else if (score > 0) {
            element.className = "method-status failed";
            indicator.className = "status-indicator error";
          } else {
            element.className = "method-status pending";
            indicator.className = "status-indicator pending";
          }
        }

        updateOverallScore(score) {
          const scoreElement = document.getElementById("overallScore");
          const progressCircle = document.getElementById("progressCircle");

          scoreElement.textContent = `${Math.round(score)}%`;

          // Update progress circle
          const circumference = 2 * Math.PI * 60;
          const offset = circumference - (score / 100) * circumference;
          progressCircle.style.strokeDashoffset = offset;
        }

        updateChallengeDisplay(status) {
          const challengeDisplay = document.getElementById("challengeDisplay");
          const challengeText = document.getElementById("challengeText");
          const challengeTimer = document.getElementById("challengeTimer");

          challengeDisplay.style.display = "block";
          challengeText.textContent = status.description;
          challengeTimer.textContent = Math.ceil(status.remaining_time);
        }

        showChallenge(challenge) {
          const challengeDisplay = document.getElementById("challengeDisplay");
          const challengeText = document.getElementById("challengeText");

          challengeDisplay.style.display = "block";
          challengeText.textContent = challenge.description;
        }

        updateSteps(data) {
          // Step 1: Face Detection
          if (
            data.landmark_results &&
            data.landmark_results.landmarks_detected
          ) {
            document.getElementById("step1").classList.add("completed");
            document.getElementById("step2").classList.add("active");
          }

          // Step 2: Liveness Analysis
          if (data.cnn_score > 0.5) {
            document.getElementById("step2").classList.add("completed");
            document.getElementById("step3").classList.add("active");
          }

          // Step 3: Challenge Response
          if (data.challenge_score > 0.5) {
            document.getElementById("step3").classList.add("completed");
            document.getElementById("step4").classList.add("active");
          }
        }

        completeVerification(success) {
          this.stopVerification();

          if (success) {
            document.getElementById("step4").classList.add("completed");
            document.getElementById("finalResult").style.display = "block";
            document.getElementById("challengeDisplay").style.display = "none";
          } else {
            this.showError("Verifikasi gagal. Silakan coba lagi.");
          }
        }

        async recordAttendance() {
          try {
            const response = await fetch("/api/complete_attendance", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                session_id: this.sessionId,
                check_type: "check_in",
                verification_data: this.verificationData,
              }),
            });

            const result = await response.json();

            if (result.success) {
              alert("Kehadiran berhasil dicatat!");
              window.location.href = "/";
            } else {
              this.showError("Gagal mencatat kehadiran.");
            }
          } catch (error) {
            console.error("Error recording attendance:", error);
            this.showError("Terjadi kesalahan saat mencatat kehadiran.");
          }
        }

        showError(message) {
          // You can implement a more sophisticated error display
          alert(message);
        }

        resetSteps() {
          ["step1", "step2", "step3", "step4"].forEach((stepId) => {
            const step = document.getElementById(stepId);
            step.classList.remove("active", "completed");
          });
        }
      }

      // Global function for parallel mode button
      function startParallelMode() {
        // Hide the mode selection card
        document.querySelector(".card.bg-dark").style.display = "none";

        // Show the verification card
        document.querySelector(".verification-card").style.display = "block";

        // Initialize parallel mode verification
        new AttendanceVerifier();
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", () => {
        // Initially hide the verification card until mode is selected
        document.querySelector(".verification-card").style.display = "none";
      });
    </script>
  </body>
</html>
