<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sequential Attendance - Face Anti-Spoofing System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
      .detection-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      .phase-card {
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        background: white;
      }

      .phase-card.active {
        border-color: #007bff;
        box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
        transform: scale(1.02);
      }

      .phase-card.completed {
        border-color: #28a745;
        background-color: #f8fff9;
      }

      .phase-card.inactive {
        opacity: 0.6;
        background-color: #f8f9fa;
      }

      .camera-container {
        position: relative;
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
        border-radius: 15px;
        overflow: hidden;
        background-color: #000;
      }

      #video {
        width: 100%;
        height: auto;
        display: block;
      }

      .camera-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 3px dashed #007bff;
        border-radius: 15px;
        pointer-events: none;
      }

      .phase-progress {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        padding: 0 20px;
        position: relative;
      }

      .phase-progress::before {
        content: "";
        position: absolute;
        top: 15px;
        left: 50px;
        right: 50px;
        height: 2px;
        background-color: #e9ecef;
        z-index: 1;
      }

      .phase-progress.phase-2::before {
        background-color: #28a745;
      }

      .phase-step {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 2;
      }

      .phase-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-weight: bold;
        font-size: 18px;
      }

      .phase-step.active .phase-circle {
        background-color: #007bff;
        color: white;
        animation: pulse 2s infinite;
      }

      .phase-step.completed .phase-circle {
        background-color: #28a745;
        color: white;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      .method-status {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 20px 0;
      }

      .method-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        background: white;
        transition: all 0.3s ease;
      }

      .method-item.passed {
        border-color: #28a745;
        background-color: #f8fff9;
      }

      .method-item.checking {
        border-color: #ffc107;
        background-color: #fffdf5;
      }

      .method-icon {
        font-size: 24px;
        margin-right: 10px;
        width: 30px;
      }

      .status-badge {
        margin-left: auto;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .status-passed {
        background-color: #28a745;
        color: white;
      }

      .status-checking {
        background-color: #ffc107;
        color: #856404;
      }

      .status-waiting {
        background-color: #6c757d;
        color: white;
      }

      .challenge-box {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        margin: 20px 0;
      }

      .challenge-instruction {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .challenge-progress {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        overflow: hidden;
        margin: 15px 0;
      }

      .challenge-progress-bar {
        height: 8px;
        background-color: white;
        transition: width 0.3s ease;
      }

      .recognition-instruction {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        margin: 20px 0;
      }

      .success-result {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        margin: 20px 0;
      }

      .error-result {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        margin: 20px 0;
      }

      .btn-restart {
        background: linear-gradient(45deg, #007bff, #0056b3);
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        color: white;
        font-weight: bold;
        transition: transform 0.3s ease;
      }

      .btn-restart:hover {
        transform: translateY(-2px);
        color: white;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container-fluid">
      <div class="detection-container">
        <!-- Header -->
        <div class="text-center mb-4">
          <h2 class="text-primary mb-3">
            <i class="fas fa-shield-alt me-2"></i>
            Sequential Face Detection
          </h2>
          <p class="text-muted">
            Verifikasi 2 tahap: Anti-Spoofing â†’ Pengenalan Wajah
          </p>
        </div>

        <!-- Phase Progress -->
        <div class="phase-progress" id="phase-progress">
          <div class="phase-step active" id="step-liveness">
            <div class="phase-circle">1</div>
            <small
              ><strong>Anti-Spoofing</strong><br />Liveness & Movement</small
            >
          </div>
          <div class="phase-step" id="step-recognition">
            <div class="phase-circle">2</div>
            <small
              ><strong>Face Recognition</strong><br />Identity
              Verification</small
            >
          </div>
        </div>

        <!-- Alert Area -->
        <div id="alert-area"></div>

        <!-- Phase 1: Anti-Spoofing -->
        <div class="phase-card active" id="phase-1-card">
          <h4 class="text-center mb-3">
            <i class="fas fa-user-shield text-primary me-2"></i>
            Tahap 1: Verifikasi Anti-Spoofing
          </h4>

          <div class="row">
            <div class="col-md-6">
              <div class="camera-container">
                <video id="video" autoplay playsinline></video>
                <div class="camera-overlay"></div>
              </div>
            </div>
            <div class="col-md-6">
              <!-- Method Status -->
              <div class="method-status">
                <div class="method-item checking" id="liveness-method">
                  <i class="fas fa-heartbeat method-icon text-danger"></i>
                  <div>
                    <strong>Liveness Detection</strong><br />
                    <small>Memastikan bukan foto/video</small>
                  </div>
                  <span class="status-badge status-checking">Checking...</span>
                </div>
                <div class="method-item checking" id="landmark-method">
                  <i class="fas fa-smile method-icon text-warning"></i>
                  <div>
                    <strong>Movement Detection</strong><br />
                    <small>Verifikasi gerakan natural</small>
                  </div>
                  <span class="status-badge status-checking">Checking...</span>
                </div>
              </div>

              <!-- Challenge Instructions -->
              <div class="challenge-box" id="challenge-box">
                <div class="challenge-instruction" id="challenge-instruction">
                  Ikuti instruksi yang muncul...
                </div>
                <div class="challenge-progress">
                  <div
                    class="challenge-progress-bar"
                    id="challenge-progress-bar"
                    style="width: 0%"
                  ></div>
                </div>
                <small id="challenge-timer">Waktu tersisa: --</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Phase 2: Face Recognition -->
        <div class="phase-card inactive" id="phase-2-card">
          <h4 class="text-center mb-3">
            <i class="fas fa-search text-success me-2"></i>
            Tahap 2: Pengenalan Wajah
          </h4>

          <div class="recognition-instruction" id="recognition-instruction">
            <i class="fas fa-camera fa-3x mb-3"></i>
            <h5>Hadap Lurus ke Kamera</h5>
            <p class="mb-0">
              Sistem sedang mencocokkan wajah Anda dengan database
            </p>
            <div class="spinner-border mt-3" role="status">
              <span class="visually-hidden">Processing...</span>
            </div>
          </div>
        </div>

        <!-- Result Area -->
        <div id="result-area"></div>

        <!-- Controls -->
        <div class="text-center mt-4">
          <button class="btn btn-restart me-3" onclick="restartDetection()">
            <i class="fas fa-redo me-2"></i>
            Mulai Ulang
          </button>
          <a href="/dashboard" class="btn btn-outline-secondary">
            <i class="fas fa-home me-2"></i>
            Dashboard
          </a>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      class SequentialDetection {
        constructor() {
          this.socket = io();
          this.video = document.getElementById("video");
          this.currentPhase = "liveness";
          this.sessionId = "sequential_" + Date.now();
          this.streamActive = false;

          this.init();
        }

        async init() {
          try {
            // Initialize camera
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: "user",
              },
            });
            this.video.srcObject = stream;
            this.streamActive = true;

            // Start processing when video loads
            this.video.addEventListener("loadedmetadata", () => {
              this.startProcessing();
            });

            // Bind socket events
            this.socket.on("liveness_result", (data) =>
              this.handleLivenessResult(data)
            );
            this.socket.on("recognition_result", (data) =>
              this.handleRecognitionResult(data)
            );
            this.socket.on("error", (data) => this.handleError(data));
          } catch (error) {
            this.showAlert(
              "error",
              "Gagal mengakses kamera. Pastikan kamera telah diizinkan."
            );
            console.error("Camera access error:", error);
          }
        }

        startProcessing() {
          if (!this.streamActive) return;

          setInterval(() => {
            this.captureAndProcess();
          }, 200); // Process every 200ms
        }

        captureAndProcess() {
          if (!this.video.videoWidth || !this.video.videoHeight) return;

          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");

          canvas.width = this.video.videoWidth;
          canvas.height = this.video.videoHeight;

          context.drawImage(this.video, 0, 0);
          const imageData = canvas.toDataURL("image/jpeg", 0.8);

          // Send to server with sequential mode
          this.socket.emit("process_frame", {
            image: imageData,
            session_id: this.sessionId,
            mode: "sequential",
          });
        }

        handleLivenessResult(data) {
          console.log("Liveness result:", data);

          if (data.status === "completed") {
            // Phase 1 completed successfully
            this.transitionToRecognition();
          } else if (data.status === "processing") {
            // Update phase 1 UI
            this.updateLivenessUI(data);
          } else if (data.status === "timeout") {
            this.showAlert("warning", data.message);
            this.restartDetection();
          }
        }

        handleRecognitionResult(data) {
          console.log("Recognition result:", data);

          if (data.status === "success") {
            // Recognition successful
            this.showSuccessResult(data.user);
            this.recordAttendance(data.user, data);
          } else if (data.status === "unknown") {
            // Unknown person
            this.showErrorResult("Wajah tidak terdaftar dalam sistem.");
          } else if (data.status === "no_face") {
            // No face detected in recognition phase
            // Continue processing
          } else if (data.status === "multiple_faces") {
            this.showAlert("warning", data.message);
          }
        }

        updateLivenessUI(data) {
          // Update liveness method status
          const livenessMethod = document.getElementById("liveness-method");
          const landmarkMethod = document.getElementById("landmark-method");

          if (data.liveness_results) {
            const livenessBadge = livenessMethod.querySelector(".status-badge");
            if (data.liveness_results.passed) {
              livenessMethod.classList.remove("checking");
              livenessMethod.classList.add("passed");
              livenessBadge.textContent = "PASSED";
              livenessBadge.className = "status-badge status-passed";
            } else {
              livenessBadge.textContent = `${(
                data.liveness_results.confidence * 100
              ).toFixed(0)}%`;
            }
          }

          if (data.landmark_results) {
            const landmarkBadge = landmarkMethod.querySelector(".status-badge");
            if (data.landmark_results.challenge_passed) {
              landmarkMethod.classList.remove("checking");
              landmarkMethod.classList.add("passed");
              landmarkBadge.textContent = "PASSED";
              landmarkBadge.className = "status-badge status-passed";
            }
          }

          // Update challenge instructions
          if (data.challenge_info) {
            document.getElementById("challenge-instruction").textContent =
              data.challenge_info.instruction;

            const progressBar = document.getElementById(
              "challenge-progress-bar"
            );
            progressBar.style.width = data.challenge_info.progress * 100 + "%";

            document.getElementById(
              "challenge-timer"
            ).textContent = `Waktu tersisa: ${Math.ceil(
              data.challenge_info.time_remaining
            )}s`;
          }
        }

        transitionToRecognition() {
          // Update progress
          document.getElementById("step-liveness").classList.remove("active");
          document.getElementById("step-liveness").classList.add("completed");
          document
            .getElementById("step-liveness")
            .querySelector(".phase-circle").innerHTML =
            '<i class="fas fa-check"></i>';

          document.getElementById("step-recognition").classList.add("active");
          document.getElementById("phase-progress").classList.add("phase-2");

          // Update cards
          document.getElementById("phase-1-card").classList.remove("active");
          document.getElementById("phase-1-card").classList.add("completed");

          document.getElementById("phase-2-card").classList.remove("inactive");
          document.getElementById("phase-2-card").classList.add("active");

          this.currentPhase = "recognition";

          this.showAlert(
            "success",
            "Anti-spoofing berhasil! Hadap lurus ke kamera untuk verifikasi identitas."
          );
        }

        showSuccessResult(user) {
          const resultHtml = `
                    <div class="success-result">
                        <i class="fas fa-check-circle fa-4x mb-3"></i>
                        <h3>Verifikasi Berhasil!</h3>
                        <p class="mb-3">Selamat datang, <strong>${
                          user.full_name
                        }</strong></p>
                        <p>Confidence: ${user.confidence.toFixed(1)}%</p>
                        <div class="mt-4">
                            <i class="fas fa-clock me-2"></i>
                            Attendance recorded at ${new Date().toLocaleString(
                              "id-ID"
                            )}
                        </div>
                    </div>
                `;

          document.getElementById("result-area").innerHTML = resultHtml;

          // Update final step
          document
            .getElementById("step-recognition")
            .classList.remove("active");
          document
            .getElementById("step-recognition")
            .classList.add("completed");
          document
            .getElementById("step-recognition")
            .querySelector(".phase-circle").innerHTML =
            '<i class="fas fa-check"></i>';
        }

        showErrorResult(message) {
          const resultHtml = `
                    <div class="error-result">
                        <i class="fas fa-times-circle fa-4x mb-3"></i>
                        <h3>Verifikasi Gagal</h3>
                        <p class="mb-3">${message}</p>
                        <button class="btn btn-light" onclick="sequentialDetection.restartDetection()">
                            <i class="fas fa-redo me-2"></i>
                            Coba Lagi
                        </button>
                    </div>
                `;

          document.getElementById("result-area").innerHTML = resultHtml;
        }

        async recordAttendance(user, detectionData) {
          try {
            const response = await fetch("/api/record-attendance", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                user: user,
                detection_data: detectionData,
              }),
            });

            const result = await response.json();
            if (!result.success) {
              console.error("Failed to record attendance:", result.message);
            }
          } catch (error) {
            console.error("Error recording attendance:", error);
          }
        }

        restartDetection() {
          // Reset UI
          document.getElementById("step-liveness").className =
            "phase-step active";
          document
            .getElementById("step-liveness")
            .querySelector(".phase-circle").textContent = "1";

          document.getElementById("step-recognition").className = "phase-step";
          document
            .getElementById("step-recognition")
            .querySelector(".phase-circle").textContent = "2";

          document.getElementById("phase-progress").classList.remove("phase-2");

          document.getElementById("phase-1-card").className =
            "phase-card active";
          document.getElementById("phase-2-card").className =
            "phase-card inactive";

          // Reset method status
          const methods = document.querySelectorAll(".method-item");
          methods.forEach((method) => {
            method.className = "method-item checking";
            method.querySelector(".status-badge").textContent = "Checking...";
            method.querySelector(".status-badge").className =
              "status-badge status-checking";
          });

          // Clear results
          document.getElementById("result-area").innerHTML = "";
          document.getElementById("alert-area").innerHTML = "";

          // Reset state
          this.currentPhase = "liveness";
          this.sessionId = "sequential_" + Date.now();

          // Reset server state
          this.socket.emit("reset_detection", { session_id: this.sessionId });
        }

        handleError(data) {
          this.showAlert("error", data.message);
        }

        showAlert(type, message) {
          const alertClass =
            type === "success"
              ? "alert-success"
              : type === "warning"
              ? "alert-warning"
              : "alert-danger";
          const icon =
            type === "success"
              ? "fa-check-circle"
              : type === "warning"
              ? "fa-exclamation-triangle"
              : "fa-times-circle";

          const alertHtml = `
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                        <i class="fas ${icon} me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;

          document.getElementById("alert-area").innerHTML = alertHtml;

          // Auto dismiss after 5 seconds
          setTimeout(() => {
            const alert = document.querySelector(".alert");
            if (alert) {
              alert.remove();
            }
          }, 5000);
        }
      }

      // Global functions
      function restartDetection() {
        if (window.sequentialDetection) {
          window.sequentialDetection.restartDetection();
        }
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", () => {
        window.sequentialDetection = new SequentialDetection();
      });
    </script>
  </body>
</html>
