<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sequential Attendance - Face Anti-Spoofing System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
      .detection-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      .phase-card {
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        background: white;
      }

      .phase-card.active {
        border-color: #007bff;
        box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
        transform: scale(1.02);
      }

      .phase-card.completed {
        border-color: #28a745;
        background-color: #f8fff9;
      }

      .phase-card.inactive {
        opacity: 0.6;
        background-color: #f8f9fa;
      }

      .camera-container {
        position: relative;
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
        border-radius: 15px;
        overflow: hidden;
        background: #000;
      }

      /* Enhanced User Guidance Styles */
      .guidance-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
      }

      .face-guide-rectangle {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 250px;
        height: 320px;
        border: 3px dashed #00ff00;
        border-radius: 15px;
        opacity: 0.8;
        transition: all 0.3s ease;
      }

      .face-guide-rectangle.good-position {
        border-color: #00ff00;
        box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
      }

      .face-guide-rectangle.adjust-position {
        border-color: #ffaa00;
        box-shadow: 0 0 15px rgba(255, 170, 0, 0.5);
      }

      .face-guide-rectangle.poor-position {
        border-color: #ff0000;
        box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
      }

      .coaching-message {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 500;
        max-width: 90%;
        text-align: center;
        z-index: 15;
        transition: all 0.3s ease;
      }

      .coaching-message.success {
        background: rgba(40, 167, 69, 0.9);
      }

      .coaching-message.warning {
        background: rgba(255, 193, 7, 0.9);
        color: #000;
      }

      .coaching-message.error {
        background: rgba(220, 53, 69, 0.9);
      }

      .progress-visualization {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #007bff;
      }

      .challenge-progress {
        margin: 15px 0;
      }

      .challenge-step {
        display: flex;
        align-items: center;
        margin: 10px 0;
        padding: 10px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .challenge-step.pending {
        background: #f8f9fa;
        border-left: 3px solid #6c757d;
      }

      .challenge-step.active {
        background: #e3f2fd;
        border-left: 3px solid #2196f3;
        animation: pulse 2s infinite;
      }

      .challenge-step.completed {
        background: #e8f5e8;
        border-left: 3px solid #4caf50;
      }

      .challenge-step.failed {
        background: #ffebee;
        border-left: 3px solid #f44336;
      }

      @keyframes pulse {
        0% { background: #e3f2fd; }
        50% { background: #bbdefb; }
        100% { background: #e3f2fd; }
      }

      .step-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 14px;
        font-weight: bold;
      }

      .step-icon.pending {
        background: #6c757d;
        color: white;
      }

      .step-icon.active {
        background: #2196f3;
        color: white;
      }

      .step-icon.completed {
        background: #4caf50;
        color: white;
      }

      .step-icon.failed {
        background: #f44336;
        color: white;
      }

      .environmental-feedback {
        margin: 15px 0;
        padding: 15px;
        border-radius: 8px;
        display: flex;
        align-items: center;
      }

      .environmental-feedback.good {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .environmental-feedback.warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
      }

      .environmental-feedback.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .method-status {
        margin: 10px 0;
        padding: 12px;
        border-radius: 8px;
        display: flex;
        justify-content: between;
        align-items: center;
      }

      .method-status.passed {
        background: #d4edda;
        border-left: 4px solid #28a745;
      }

      .method-status.failed {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
      }

      .method-status.pending {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
      }

      .retry-section {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        text-align: center;
        display: none;
      }

      .retry-section.show {
        display: block;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .audio-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 20;
      }

      .audio-toggle {
        background: rgba(0, 0, 0, 0.7);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .audio-toggle:hover {
        background: rgba(0, 0, 0, 0.9);
      }

      .quality-indicators {
        position: absolute;
        bottom: 10px;
        left: 10px;
        display: flex;
        gap: 10px;
        z-index: 15;
      }

      .quality-indicator {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        color: white;
      }

      .quality-indicator.good {
        background: rgba(40, 167, 69, 0.9);
      }

      .quality-indicator.warning {
        background: rgba(255, 193, 7, 0.9);
      }

      .quality-indicator.error {
        background: rgba(220, 53, 69, 0.9);
      }
        margin: 0 auto;
        border-radius: 15px;
        overflow: hidden;
        background-color: #000;
      }

      #video {
        width: 100%;
        height: auto;
        display: block;
      }

      .camera-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 3px dashed #007bff;
        border-radius: 15px;
        pointer-events: none;
      }

      .phase-progress {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        padding: 0 20px;
        position: relative;
      }

      .phase-progress::before {
        content: "";
        position: absolute;
        top: 15px;
        left: 50px;
        right: 50px;
        height: 2px;
        background-color: #e9ecef;
        z-index: 1;
      }

      .phase-progress.phase-2::before {
        background-color: #28a745;
      }

      .phase-step {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 2;
      }

      .phase-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-weight: bold;
        font-size: 18px;
      }

      .phase-step.active .phase-circle {
        background-color: #007bff;
        color: white;
        animation: pulse 2s infinite;
      }

      .phase-step.completed .phase-circle {
        background-color: #28a745;
        color: white;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      .method-status {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 20px 0;
      }

      .method-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        background: white;
        transition: all 0.3s ease;
      }

      .method-item.passed {
        border-color: #28a745;
        background-color: #f8fff9;
      }

      .method-item.checking {
        border-color: #ffc107;
        background-color: #fffdf5;
      }

      .method-icon {
        font-size: 24px;
        margin-right: 10px;
        width: 30px;
      }

      .status-badge {
        margin-left: auto;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .status-passed {
        background-color: #28a745;
        color: white;
      }

      .status-checking {
        background-color: #ffc107;
        color: #856404;
      }

      .status-waiting {
        background-color: #6c757d;
        color: white;
      }

      .challenge-box {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        margin: 20px 0;
      }

      .challenge-instruction {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .challenge-progress {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        overflow: hidden;
        margin: 15px 0;
      }

      .challenge-progress-bar {
        height: 8px;
        background-color: white;
        transition: width 0.3s ease;
      }

      .recognition-instruction {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        margin: 20px 0;
      }

      .success-result {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        margin: 20px 0;
      }

      .error-result {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        margin: 20px 0;
      }

      .btn-restart {
        background: linear-gradient(45deg, #007bff, #0056b3);
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        color: white;
        font-weight: bold;
        transition: transform 0.3s ease;
      }

      .btn-restart:hover {
        transform: translateY(-2px);
        color: white;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container-fluid">
      <div class="detection-container">
        <!-- Header -->
        <div class="text-center mb-4">
          <h2 class="text-primary mb-3">
            <i class="fas fa-shield-alt me-2"></i>
            Sequential Face Detection
          </h2>
          <p class="text-muted">
            Verifikasi 2 tahap: Anti-Spoofing → Pengenalan Wajah
          </p>
        </div>

        <!-- Phase Progress -->
        <div class="phase-progress" id="phase-progress">
          <div class="phase-step active" id="step-liveness">
            <div class="phase-circle">1</div>
            <small
              ><strong>Anti-Spoofing</strong><br />Liveness & Movement</small
            >
          </div>
          <div class="phase-step" id="step-recognition">
            <div class="phase-circle">2</div>
            <small
              ><strong>Face Recognition</strong><br />Identity
              Verification</small
            >
          </div>
        </div>

        <!-- Alert Area -->
        <div id="alert-area"></div>

        <!-- Phase 1: Anti-Spoofing -->
        <div class="phase-card active" id="phase-1-card">
          <h4 class="text-center mb-3">
            <i class="fas fa-user-shield text-primary me-2"></i>
            Tahap 1: Verifikasi Anti-Spoofing
          </h4>

          <div class="row">
            <div class="col-md-6">
              <div class="camera-container">
                <video id="video" autoplay playsinline></video>
                <div class="camera-overlay"></div>

                <!-- Enhanced User Guidance Overlay -->
                <div class="guidance-overlay" id="guidanceOverlay">
                  <!-- Face Positioning Guide -->
                  <div class="face-guide-rectangle" id="faceGuide"></div>

                  <!-- Real-time Coaching Messages -->
                  <div class="coaching-message" id="coachingMessage">
                    Position your face in the guide rectangle
                  </div>

                  <!-- Quality Indicators -->
                  <div class="quality-indicators" id="qualityIndicators">
                    <span class="quality-indicator" id="lightingIndicator"
                      >Lighting</span
                    >
                    <span class="quality-indicator" id="distanceIndicator"
                      >Distance</span
                    >
                    <span class="quality-indicator" id="angleIndicator"
                      >Angle</span
                    >
                  </div>
                </div>

                <!-- Audio Controls -->
                <div class="audio-controls">
                  <button
                    class="audio-toggle"
                    id="audioToggle"
                    onclick="toggleAudioInstructions()"
                  >
                    🔊 Audio On
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <!-- Progress Visualization -->
              <div class="progress-visualization" id="progressVisualization">
                <h5>
                  <i class="fas fa-tasks"></i> Anti-Spoofing Verification
                  Progress
                </h5>
                <div class="challenge-progress" id="challengeProgress">
                  <div class="challenge-step pending" id="step-initialization">
                    <div class="step-icon pending">1</div>
                    <div>
                      <strong>Camera Initialization</strong>
                      <div style="font-size: 12px; color: #6c757d">
                        Setting up camera and preparing detection
                      </div>
                    </div>
                  </div>
                  <div class="challenge-step pending" id="step-face-detection">
                    <div class="step-icon pending">2</div>
                    <div>
                      <strong>Face Detection</strong>
                      <div style="font-size: 12px; color: #6c757d">
                        Locating and tracking your face
                      </div>
                    </div>
                  </div>
                  <div class="challenge-step pending" id="step-quality-check">
                    <div class="step-icon pending">3</div>
                    <div>
                      <strong>Quality Assessment</strong>
                      <div style="font-size: 12px; color: #6c757d">
                        Checking lighting, distance, and clarity
                      </div>
                    </div>
                  </div>
                  <div class="challenge-step pending" id="step-blink-detection">
                    <div class="step-icon pending">4</div>
                    <div>
                      <strong>Blink Detection</strong>
                      <div style="font-size: 12px; color: #6c757d">
                        Please blink naturally when prompted
                      </div>
                    </div>
                  </div>
                  <div
                    class="challenge-step pending"
                    id="step-texture-analysis"
                  >
                    <div class="step-icon pending">5</div>
                    <div>
                      <strong>Texture Analysis</strong>
                      <div style="font-size: 12px; color: #6c757d">
                        Analyzing facial texture patterns
                      </div>
                    </div>
                  </div>
                  <div class="challenge-step pending" id="step-depth-analysis">
                    <div class="step-icon pending">6</div>
                    <div>
                      <strong>Depth Analysis</strong>
                      <div style="font-size: 12px; color: #6c757d">
                        Measuring facial depth and 3D structure
                      </div>
                    </div>
                  </div>
                  <div
                    class="challenge-step pending"
                    id="step-final-verification"
                  >
                    <div class="step-icon pending">9</div>
                    <div>
                      <strong>Final Verification</strong>
                      <div style="font-size: 12px; color: #6c757d">
                        Combining all anti-spoofing methods
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Environmental Feedback -->
              <div
                class="environmental-feedback good"
                id="environmentalFeedback"
              >
                <i class="fas fa-check-circle" style="margin-right: 10px"></i>
                <span id="environmentalMessage"
                  >Environment conditions are optimal</span
                >
              </div>

              <!-- Method Status -->
              <div class="method-status">
                <div class="method-item checking" id="liveness-method">
                  <i class="fas fa-heartbeat method-icon text-danger"></i>
                  <div>
                    <strong>Liveness Detection</strong><br />
                    <small>Memastikan bukan foto/video</small>
                  </div>
                  <span class="status-badge status-checking">Checking...</span>
                </div>
                <div class="method-item checking" id="landmark-method">
                  <i class="fas fa-smile method-icon text-warning"></i>
                  <div>
                    <strong>Movement Detection</strong><br />
                    <small>Verifikasi gerakan natural</small>
                  </div>
                  <span class="status-badge status-checking">Checking...</span>
                </div>
                <div class="method-item checking" id="texture-method">
                  <i class="fas fa-fingerprint method-icon text-info"></i>
                  <div>
                    <strong>Texture Analysis</strong><br />
                    <small>Analisis tekstur kulit natural</small>
                  </div>
                  <span class="status-badge status-checking">Checking...</span>
                </div>
                <div class="method-item checking" id="depth-method">
                  <i class="fas fa-cube method-icon text-success"></i>
                  <div>
                    <strong>3D Depth Analysis</strong><br />
                    <small>Verifikasi struktur wajah 3D</small>
                  </div>
                  <span class="status-badge status-checking">Checking...</span>
                </div>
                <div class="method-item checking" id="distance-method">
                  <i class="fas fa-ruler method-icon text-info"></i>
                  <div>
                    <strong>Distance Validation</strong><br />
                    <small>Proximity and movement verification</small>
                  </div>
                  <span class="status-badge status-checking">Checking...</span>
                </div>
              </div>

              <!-- Challenge Instructions -->
              <div class="challenge-box" id="challenge-box">
                <div class="challenge-instruction" id="challenge-instruction">
                  Ikuti instruksi yang muncul...
                </div>
                <div class="challenge-progress">
                  <div
                    class="challenge-progress-bar"
                    id="challenge-progress-bar"
                    style="width: 0%"
                  ></div>
                </div>
                <small id="challenge-timer">Waktu tersisa: --</small>

                <!-- Distance Challenge Progress -->
                <div
                  id="distance-progress"
                  style="display: none; margin-top: 10px"
                >
                  <div style="font-size: 14px; color: white">
                    <span id="distance-status">Distance Status</span>
                  </div>
                  <div style="font-size: 12px; opacity: 0.8">
                    <span id="distance-ratio">Current: --</span>
                  </div>
                </div>

                <!-- Audio Controls -->
                <div style="margin-top: 15px; text-align: center">
                  <button
                    class="btn btn-sm btn-outline-light"
                    id="audioToggleBtn"
                    onclick="toggleAudioFeedback()"
                    style="border-radius: 20px"
                  >
                    🔊 Audio Instructions
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Phase 2: Face Recognition -->
        <div class="phase-card inactive" id="phase-2-card">
          <h4 class="text-center mb-3">
            <i class="fas fa-search text-success me-2"></i>
            Tahap 2: Pengenalan Wajah
          </h4>

          <div class="recognition-instruction" id="recognition-instruction">
            <i class="fas fa-camera fa-3x mb-3"></i>
            <h5>Hadap Lurus ke Kamera</h5>
            <p class="mb-0">
              Sistem sedang mencocokkan wajah Anda dengan database
            </p>
            <div class="spinner-border mt-3" role="status">
              <span class="visually-hidden">Processing...</span>
            </div>
          </div>
        </div>

        <!-- Result Area -->
        <div id="result-area"></div>

        <!-- Retry Section -->
        <div class="retry-section" id="retrySection">
          <h5><i class="fas fa-redo"></i> Verification Failed</h5>
          <p id="retryMessage">
            Some anti-spoofing checks didn't pass. Please follow the guidance
            below and try again:
          </p>
          <div id="retryGuidance"></div>
          <button class="btn btn-primary" onclick="retryVerification()">
            <i class="fas fa-redo"></i> Try Again
          </button>
        </div>

        <!-- Controls -->
        <div class="text-center mt-4">
          <button class="btn btn-restart me-3" onclick="restartDetection()">
            <i class="fas fa-redo me-2"></i>
            Mulai Ulang
          </button>
          <a href="/dashboard" class="btn btn-outline-secondary">
            <i class="fas fa-home me-2"></i>
            Dashboard
          </a>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      class SequentialDetection {
        constructor() {
          this.socket = io();
          this.video = document.getElementById("video");
          this.currentPhase = "liveness";
          this.sessionId = "sequential_" + Date.now();
          this.streamActive = false;

          this.init();
        }

        async init() {
          try {
            // Initialize camera
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: "user",
              },
            });
            this.video.srcObject = stream;
            this.streamActive = true;

            // Start processing when video loads
            this.video.addEventListener("loadedmetadata", () => {
              this.startProcessing();
            });

            // Bind socket events
            this.socket.on("liveness_result", (data) =>
              this.handleLivenessResult(data)
            );
            this.socket.on("recognition_result", (data) =>
              this.handleRecognitionResult(data)
            );
            this.socket.on("error", (data) => this.handleError(data));
          } catch (error) {
            this.showAlert(
              "error",
              "Gagal mengakses kamera. Pastikan kamera telah diizinkan."
            );
            console.error("Camera access error:", error);
          }
        }

        startProcessing() {
          if (!this.streamActive) return;

          setInterval(() => {
            this.captureAndProcess();
          }, 200); // Process every 200ms
        }

        captureAndProcess() {
          if (!this.video.videoWidth || !this.video.videoHeight) return;

          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");

          canvas.width = this.video.videoWidth;
          canvas.height = this.video.videoHeight;

          context.drawImage(this.video, 0, 0);
          const imageData = canvas.toDataURL("image/jpeg", 0.8);

          // Send to server with sequential mode
          this.socket.emit("process_frame", {
            image: imageData,
            session_id: this.sessionId,
            mode: "sequential",
          });
        }

        handleLivenessResult(data) {
          console.log("Liveness result:", data);

          if (data.status === "completed") {
            // Phase 1 completed successfully
            this.transitionToRecognition();
          } else if (data.status === "processing") {
            // Update phase 1 UI
            this.updateLivenessUI(data);
          } else if (data.status === "timeout") {
            this.showAlert("warning", data.message);
            this.restartDetection();
          }
        }

        handleRecognitionResult(data) {
          console.log("Recognition result:", data);

          if (data.status === "success") {
            // Recognition successful
            this.showSuccessResult(data.user);
            this.recordAttendance(data.user, data);
          } else if (data.status === "unknown") {
            // Unknown person
            this.showErrorResult("Wajah tidak terdaftar dalam sistem.");
          } else if (data.status === "no_face") {
            // No face detected in recognition phase
            // Continue processing
          } else if (data.status === "multiple_faces") {
            this.showAlert("warning", data.message);
          }
        }

        updateLivenessUI(data) {
          // Update liveness method status
          const livenessMethod = document.getElementById("liveness-method");
          const landmarkMethod = document.getElementById("landmark-method");
          const distanceMethod = document.getElementById("distance-method");

          if (data.liveness_results) {
            const livenessBadge = livenessMethod.querySelector(".status-badge");
            if (data.liveness_results.passed) {
              livenessMethod.classList.remove("checking");
              livenessMethod.classList.add("passed");
              livenessBadge.textContent = "PASSED";
              livenessBadge.className = "status-badge status-passed";
            } else {
              livenessBadge.textContent = `${(
                data.liveness_results.confidence * 100
              ).toFixed(0)}%`;
            }
          }

          if (data.landmark_results) {
            const landmarkBadge = landmarkMethod.querySelector(".status-badge");
            if (data.landmark_results.challenge_passed) {
              landmarkMethod.classList.remove("checking");
              landmarkMethod.classList.add("passed");
              landmarkBadge.textContent = "PASSED";
              landmarkBadge.className = "status-badge status-passed";
            }
          }

          // Update distance method if available
          if (data.distance_results && distanceMethod) {
            const distanceBadge = distanceMethod.querySelector(".status-badge");
            if (data.distance_results.challenge_passed) {
              distanceMethod.classList.remove("checking");
              distanceMethod.classList.add("passed");
              distanceBadge.textContent = "PASSED";
              distanceBadge.className = "status-badge status-passed";
            } else {
              distanceBadge.textContent = `${(
                (data.distance_results.progress || 0) * 100
              ).toFixed(0)}%`;
            }
          }

          // Update challenge instructions with distance info
          if (data.challenge_info) {
            document.getElementById("challenge-instruction").textContent =
              data.challenge_info.instruction;

            const progressBar = document.getElementById(
              "challenge-progress-bar"
            );
            progressBar.style.width = data.challenge_info.progress * 100 + "%";

            document.getElementById(
              "challenge-timer"
            ).textContent = `Waktu tersisa: ${Math.ceil(
              data.challenge_info.time_remaining
            )}s`;

            // Show distance progress if it's a distance challenge
            const distanceProgress =
              document.getElementById("distance-progress");
            const distanceStatus = document.getElementById("distance-status");
            const distanceRatio = document.getElementById("distance-ratio");

            if (
              data.challenge_info.challenge_type &&
              (data.challenge_info.challenge_type.includes("distance") ||
                data.challenge_info.challenge_type.includes("move"))
            ) {
              distanceProgress.style.display = "block";
              distanceStatus.textContent =
                data.challenge_info.status || "Moving...";

              if (data.challenge_info.distance_info) {
                const ratio =
                  data.challenge_info.distance_info.size_ratio || 1.0;
                distanceRatio.textContent = `Current: ${(ratio * 100).toFixed(
                  0
                )}%`;
              }
            } else {
              distanceProgress.style.display = "none";
            }

            // Audio feedback for challenge updates
            if (audioEnabled && data.challenge_info.audio_message) {
              speakInstruction(data.challenge_info.audio_message);
            }
          }
        }

        transitionToRecognition() {
          // Update progress
          document.getElementById("step-liveness").classList.remove("active");
          document.getElementById("step-liveness").classList.add("completed");
          document
            .getElementById("step-liveness")
            .querySelector(".phase-circle").innerHTML =
            '<i class="fas fa-check"></i>';

          document.getElementById("step-recognition").classList.add("active");
          document.getElementById("phase-progress").classList.add("phase-2");

          // Update cards
          document.getElementById("phase-1-card").classList.remove("active");
          document.getElementById("phase-1-card").classList.add("completed");

          document.getElementById("phase-2-card").classList.remove("inactive");
          document.getElementById("phase-2-card").classList.add("active");

          this.currentPhase = "recognition";

          this.showAlert(
            "success",
            "Anti-spoofing berhasil! Hadap lurus ke kamera untuk verifikasi identitas."
          );
        }

        showSuccessResult(user) {
          const resultHtml = `
                    <div class="success-result">
                        <i class="fas fa-check-circle fa-4x mb-3"></i>
                        <h3>Verifikasi Berhasil!</h3>
                        <p class="mb-3">Selamat datang, <strong>${
                          user.full_name
                        }</strong></p>
                        <p>Confidence: ${user.confidence.toFixed(1)}%</p>
                        <div class="mt-4">
                            <i class="fas fa-clock me-2"></i>
                            Attendance recorded at ${new Date().toLocaleString(
                              "id-ID"
                            )}
                        </div>
                    </div>
                `;

          document.getElementById("result-area").innerHTML = resultHtml;

          // Update final step
          document
            .getElementById("step-recognition")
            .classList.remove("active");
          document
            .getElementById("step-recognition")
            .classList.add("completed");
          document
            .getElementById("step-recognition")
            .querySelector(".phase-circle").innerHTML =
            '<i class="fas fa-check"></i>';
        }

        showErrorResult(message) {
          const resultHtml = `
                    <div class="error-result">
                        <i class="fas fa-times-circle fa-4x mb-3"></i>
                        <h3>Verifikasi Gagal</h3>
                        <p class="mb-3">${message}</p>
                        <button class="btn btn-light" onclick="sequentialDetection.restartDetection()">
                            <i class="fas fa-redo me-2"></i>
                            Coba Lagi
                        </button>
                    </div>
                `;

          document.getElementById("result-area").innerHTML = resultHtml;
        }

        async recordAttendance(user, detectionData) {
          try {
            const response = await fetch("/api/record-attendance", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                user: user,
                detection_data: detectionData,
              }),
            });

            const result = await response.json();
            if (!result.success) {
              console.error("Failed to record attendance:", result.message);
            }
          } catch (error) {
            console.error("Error recording attendance:", error);
          }
        }

        restartDetection() {
          // Reset UI
          document.getElementById("step-liveness").className =
            "phase-step active";
          document
            .getElementById("step-liveness")
            .querySelector(".phase-circle").textContent = "1";

          document.getElementById("step-recognition").className = "phase-step";
          document
            .getElementById("step-recognition")
            .querySelector(".phase-circle").textContent = "2";

          document.getElementById("phase-progress").classList.remove("phase-2");

          document.getElementById("phase-1-card").className =
            "phase-card active";
          document.getElementById("phase-2-card").className =
            "phase-card inactive";

          // Reset method status
          const methods = document.querySelectorAll(".method-item");
          methods.forEach((method) => {
            method.className = "method-item checking";
            method.querySelector(".status-badge").textContent = "Checking...";
            method.querySelector(".status-badge").className =
              "status-badge status-checking";
          });

          // Clear results
          document.getElementById("result-area").innerHTML = "";
          document.getElementById("alert-area").innerHTML = "";

          // Reset state
          this.currentPhase = "liveness";
          this.sessionId = "sequential_" + Date.now();

          // Reset server state
          this.socket.emit("reset_detection", { session_id: this.sessionId });
        }

        handleError(data) {
          this.showAlert("error", data.message);
        }

        showAlert(type, message) {
          const alertClass =
            type === "success"
              ? "alert-success"
              : type === "warning"
              ? "alert-warning"
              : "alert-danger";
          const icon =
            type === "success"
              ? "fa-check-circle"
              : type === "warning"
              ? "fa-exclamation-triangle"
              : "fa-times-circle";

          const alertHtml = `
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                        <i class="fas ${icon} me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;

          document.getElementById("alert-area").innerHTML = alertHtml;

          // Auto dismiss after 5 seconds
          setTimeout(() => {
            const alert = document.querySelector(".alert");
            if (alert) {
              alert.remove();
            }
          }, 5000);
        }
      }

      // Enhanced User Experience Functions
      let audioEnabled = true;
      let speechSynthesis = window.speechSynthesis;

      function toggleAudioInstructions() {
        audioEnabled = !audioEnabled;
        const toggle = document.getElementById("audioToggle");
        toggle.innerHTML = audioEnabled ? "🔊 Audio On" : "🔇 Audio Off";

        if (audioEnabled) {
          speakInstruction("Audio instructions enabled");
        }
      }

      function toggleAudioFeedback() {
        audioEnabled = !audioEnabled;
        const toggle = document.getElementById("audioToggleBtn");
        toggle.innerHTML = audioEnabled
          ? "🔊 Audio Instructions"
          : "🔇 Audio Off";
        toggle.className = audioEnabled
          ? "btn btn-sm btn-outline-light"
          : "btn btn-sm btn-outline-secondary";

        if (audioEnabled) {
          speakInstruction("Audio feedback enabled");
        }

        // Send audio preference to server
        if (window.sequentialDetection && window.sequentialDetection.socket) {
          window.sequentialDetection.socket.emit("set_audio_enabled", {
            audio_enabled: audioEnabled,
          });
        }
      }

      function speakInstruction(message) {
        if (!audioEnabled || !speechSynthesis) return;

        const utterance = new SpeechSynthesisUtterance(message);
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 0.8;
        speechSynthesis.speak(utterance);
      }

      function updateCoachingMessage(message, type = "info") {
        const coachingElement = document.getElementById("coachingMessage");
        if (coachingElement) {
          coachingElement.textContent = message;
          coachingElement.className = `coaching-message ${type}`;

          if (audioEnabled) {
            speakInstruction(message);
          }
        }
      }

      function updateFaceGuide(status) {
        const faceGuide = document.getElementById("faceGuide");
        if (faceGuide) {
          faceGuide.className = `face-guide-rectangle ${status}`;
        }
      }

      function updateQualityIndicators(lighting, distance, angle) {
        const indicators = {
          lightingIndicator: lighting,
          distanceIndicator: distance,
          angleIndicator: angle,
        };

        Object.keys(indicators).forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            const status = indicators[id];
            element.className = `quality-indicator ${status}`;
          }
        });
      }

      function updateEnvironmentalFeedback(message, type) {
        const feedback = document.getElementById("environmentalFeedback");
        const messageElement = document.getElementById("environmentalMessage");

        if (feedback && messageElement) {
          feedback.className = `environmental-feedback ${type}`;
          messageElement.textContent = message;

          const icon = feedback.querySelector("i");
          if (icon) {
            switch (type) {
              case "good":
                icon.className = "fas fa-check-circle";
                break;
              case "warning":
                icon.className = "fas fa-exclamation-triangle";
                break;
              case "error":
                icon.className = "fas fa-times-circle";
                break;
            }
          }
        }
      }

      function updateChallengeStep(stepId, status) {
        const step = document.getElementById(stepId);
        if (step) {
          step.className = `challenge-step ${status}`;
          const icon = step.querySelector(".step-icon");
          if (icon) {
            icon.className = `step-icon ${status}`;
            if (status === "completed") {
              icon.innerHTML = "✓";
            } else if (status === "failed") {
              icon.innerHTML = "✗";
            }
          }
        }
      }

      function updateMethodStatus(methodId, status, explanation = "") {
        const method = document.getElementById(methodId);
        if (method) {
          method.className = `method-status ${status}`;
          const badge = method.querySelector(".status-badge");
          if (badge) {
            switch (status) {
              case "passed":
                badge.textContent = "Passed";
                badge.className = "badge badge-success";
                break;
              case "failed":
                badge.textContent = "Failed";
                badge.className = "badge badge-danger";
                break;
              case "checking":
                badge.textContent = "Checking...";
                badge.className = "badge badge-warning";
                break;
            }
          }

          if (explanation) {
            const small = method.querySelector("small");
            if (small) {
              small.textContent = explanation;
            }
          }
        }
      }

      function showRetrySection(failedMethods, recommendations) {
        const retrySection = document.getElementById("retrySection");
        const retryGuidance = document.getElementById("retryGuidance");

        if (retrySection && retryGuidance) {
          let guidanceHtml = "<h6>Failed Checks:</h6><ul>";
          failedMethods.forEach((method) => {
            guidanceHtml += `<li><strong>${method.name}:</strong> ${method.reason}</li>`;
          });
          guidanceHtml += "</ul><h6>Recommendations:</h6><ul>";
          recommendations.forEach((rec) => {
            guidanceHtml += `<li>${rec}</li>`;
          });
          guidanceHtml += "</ul>";

          retryGuidance.innerHTML = guidanceHtml;
          retrySection.classList.add("show");

          if (audioEnabled) {
            speakInstruction(
              "Verification failed. Please follow the recommendations and try again."
            );
          }
        }
      }

      function retryVerification() {
        const retrySection = document.getElementById("retrySection");
        if (retrySection) {
          retrySection.classList.remove("show");
        }

        // Reset all progress indicators
        const steps = [
          "step-initialization",
          "step-face-detection",
          "step-quality-check",
          "step-blink-detection",
          "step-texture-analysis",
          "step-depth-analysis",
          "step-final-verification",
        ];
        steps.forEach((stepId) => updateChallengeStep(stepId, "pending"));

        // Reset method status
        const methods = [
          "liveness-method",
          "landmark-method",
          "texture-method",
          "depth-method",
        ];
        methods.forEach((methodId) => updateMethodStatus(methodId, "checking"));

        updateCoachingMessage(
          "Position your face in the guide rectangle",
          "info"
        );
        updateEnvironmentalFeedback("Preparing for retry...", "warning");

        if (audioEnabled) {
          speakInstruction(
            "Starting verification retry. Please position your face in the guide rectangle."
          );
        }

        // Restart the detection process
        if (window.sequentialDetection) {
          window.sequentialDetection.restartDetection();
        }
      }

      // Enhanced detection guidance
      function analyzeFrameQuality(frame) {
        // This would be called from the detection system
        let lighting = "good";
        let distance = "good";
        let angle = "good";
        let message = "Perfect positioning!";
        let messageType = "success";

        // Example quality analysis logic would go here
        // For now, we'll provide placeholder guidance

        updateQualityIndicators(lighting, distance, angle);
        updateCoachingMessage(message, messageType);
        updateFaceGuide(
          lighting === "good" && distance === "good" && angle === "good"
            ? "good-position"
            : "adjust-position"
        );
      }

      // Global functions
      function restartDetection() {
        if (window.sequentialDetection) {
          window.sequentialDetection.restartDetection();
        }
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", () => {
        window.sequentialDetection = new SequentialDetection();

        // Initialize enhanced features
        updateCoachingMessage(
          "Position your face in the guide rectangle",
          "info"
        );
        updateEnvironmentalFeedback("Camera initializing...", "warning");
        updateChallengeStep("step-initialization", "active");

        if (audioEnabled) {
          speakInstruction(
            "Welcome to face verification. Please position your face in the guide rectangle."
          );
        }
      });
    </script>
  </body>
</html>
